<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>alignment prober</title>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<script type="text/javascript" src="util.js"></script>
		<script type="text/javascript" src="cache_line_probe.js"></script>
		<script type="text/javascript" src="page_probe.js"></script>
		<script type="text/javascript" src="graph.js"></script>
		<script type="text/javascript">
			const ALLOC_SIZE = 16 * 0x100000; // allocation size, will be larger once we get to 4KiB probing
			const ab = new ArrayBuffer(ALLOC_SIZE); // we're going to assume this is at least 8-byte aligned, for efficient acces of 64-bit values.

			const CACHE_LINE_SEARCH_SIZE = 2 * 0x100000; // exceed L1 but not necessarily L2/L3
			const ab32 = new Uint32Array(ab, 0, CACHE_LINE_SEARCH_SIZE / Uint32Array.BYTES_PER_ELEMENT + 3);

			const c = document.getElementById("canvas");
			cache_line_probe(
				ab32,
				(wip_results_y, wip_results_x) => {
					plot_graph(c, wip_results_y, wip_results_x);
				},
				(cache_line_offset, cache_line_size_bytes, err) => {
					let msg;
					if (err) {
						msg = err;
					} else {
						msg = "Cache line size: " + cache_line_size_bytes + " bytes. Cache line offset: " + cache_line_offset;
					}
					let p = document.createElement("p");
					p.innerText = msg;
					document.body.appendChild(p);

					const ab32_cache_aligned = new Uint32Array(ab, cache_line_offset, Math.floor((ALLOC_SIZE - cache_line_offset) / Uint32Array.BYTES_PER_ELEMENT));
					page_probe(
						ab32_cache_aligned,
						(wip_results_y, wip_results_x) => {
							plot_graph(c, wip_results_y, null);
						},
						(cache_line_offset, cache_line_size_bytes, err) => {
							let msg;
							if (err) {
								msg = err;
							} else {
								msg = "Cache line size: " + cache_line_size_bytes + " bytes. Cache line offset: " + cache_line_offset;
							}
							let p = document.createElement("p");
							p.innerText = msg;
							document.body.appendChild(p);
						}
					);

				}
			);

		</script>
	</body>
</html>
